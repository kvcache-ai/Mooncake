@startuml oplog-data-flow
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center

actor Client
participant "Primary Master" as Primary
participant "OpLogManager" as OplogMgr
participant "EtcdOpLogStore" as EtcdStore
database etcd
participant "OpLogWatcher" as Watcher
participant "OpLogApplier" as Applier
participant "Standby Master" as Standby

== PUT_END 操作流程 ==

Client -> Primary: PutEnd(key, ...)
activate Primary
Primary -> OplogMgr: Append(PUT_END, key)
activate OplogMgr
OplogMgr -> OplogMgr: 生成 sequence_id\n生成 key_sequence_id
OplogMgr -> EtcdStore: WriteOpLog(entry)
activate EtcdStore
EtcdStore -> etcd: PUT /oplog/{seq}
activate etcd
etcd --> EtcdStore: Success
deactivate etcd
EtcdStore --> OplogMgr: Success
deactivate EtcdStore
OplogMgr --> Primary: sequence_id
deactivate OplogMgr
Primary --> Client: Success
deactivate Primary

== Standby 同步流程 ==

etcd -> Watcher: Watch Event (新 OpLog)
activate Watcher
Watcher -> Applier: ApplyOpLogEntry(entry)
activate Applier
Applier -> Applier: CheckSequenceOrder()
alt 顺序正确
    Applier -> Standby: UpdateMetadata(key, ...)
    activate Standby
    Standby --> Applier: Success
    deactivate Standby
else 顺序错误
    Applier -> Applier: RollbackAndReplay()
    Applier -> etcd: ReadOpLogForKey()
    etcd --> Applier: OpLog Entries
    Applier -> Applier: Replay OpLog
end
Applier --> Watcher: Success
deactivate Applier
deactivate Watcher

@enduml

