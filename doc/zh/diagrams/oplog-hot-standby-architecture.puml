@startuml oplog-hot-standby-architecture
!theme plain
skinparam backgroundColor #FFFFFF
skinparam componentStyle rectangle
skinparam defaultFontSize 12

package "Primary Master" #E8F4F8 {
    component [MasterService] as MasterService
    component [OpLogManager] as OpLogManager
    component [EtcdOpLogStore] as EtcdOpLogStore
    
    MasterService --> OpLogManager : 记录操作
    OpLogManager --> EtcdOpLogStore : 写入 OpLog
}

package "etcd Cluster" #FFF4E6 {
    database [etcd] as etcd
}

package "Standby Master" #F0F8E8 {
    component [MasterServiceSupervisor] as Supervisor
    component [HotStandbyService] as HotStandby
    component [OpLogWatcher] as Watcher
    component [OpLogApplier] as Applier
    component [MetadataStore] as MetadataStore
    
    Supervisor --> HotStandby : 启动/停止
    HotStandby --> Watcher : Watch OpLog
    Watcher --> Applier : 应用 OpLog
    Applier --> MetadataStore : 更新 metadata
}

EtcdOpLogStore --> etcd : 写入 OpLog
etcd --> Watcher : Watch 事件

note right of OpLogManager
  **职责**：
  - 生成 sequence_id
  - 生成 key_sequence_id
  - 维护内存缓冲区
end note

note right of Applier
  **职责**：
  - 检查顺序
  - 处理乱序
  - 清理过期条目
end note

note right of MasterService
  **操作**：
  - PutEnd()
  - Remove()
  - Eviction()
end note

note right of etcd
  **Key 设计**：
  - /oplog/{cluster_id}/{sequence_id}
  - /oplog/{cluster_id}/latest
  - Watch API
end note

@enduml

